/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as d,Fragment as B,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{useRef as E,useEffect as y,useMemo as Q,useState as F,useReducer as W,createContext as Z,useContext as G}from"@dropins/tools/preact-compat.js";import{g as J,c as x}from"../chunks/currency-symbol-map.js";import{s as Y,a as ee,b as te}from"../chunks/searchProducts.js";import{v as ne}from"../chunks/tokens.js";import"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact.js";const L={SEARCH_INPUT_CONTEXT:"searchInputContext",SEARCH_RESULTS_CONTEXT:"searchResultsContext"},R={SEARCH_PRODUCT_CLICK:"search-product-click",SEARCH_SUGGESTION_CLICK:"search-suggestion-click",SEARCH_REQUEST_SENT:"search-request-sent",SEARCH_RESPONSE_RECEIVED:"search-response-received",SEARCH_RESULTS_VIEW:"search-results-view"},w=()=>(window.adobeDataLayer=window.adobeDataLayer||[],window.adobeDataLayer);function K(e,t){w().push({[e]:t})}function I(e,t){w().push(c=>{var o;const r=((o=c.getState)==null?void 0:o.call(c))??{};c.push({event:e,eventInfo:{...r,...t}})})}const C="livesearch-popover-dropin",re=()=>({publishSearchProductClick:o=>{I(R.SEARCH_PRODUCT_CLICK,{searchUnitId:C,sku:o})},updateSearchInputContext:()=>{},searchRequestSent:()=>{},searchResponseReceived:()=>{},searchResultsView:()=>{}});function $(e){var t,n,c="";if(typeof e=="string"||typeof e=="number")c+=e;else if(typeof e=="object")if(Array.isArray(e)){var r=e.length;for(t=0;t<r;t++)e[t]&&(n=$(e[t]))&&(c&&(c+=" "),c+=n)}else for(n in e)e[n]&&(c&&(c+=" "),c+=n);return c}function q(){for(var e,t,n=0,c="",r=arguments.length;n<r;n++)(e=arguments[n])&&(t=$(e))&&(c&&(c+=" "),c+=t);return c}function ce(){return d("svg",{width:"60",height:"74",viewBox:"0 0 60 74",children:d("path",{d:"M26,85H70a8.009,8.009,0,0,0,8-8V29.941a7.947,7.947,0,0,0-2.343-5.657L64.716,13.343A7.946,7.946,0,0,0,59.059,11H26a8.009,8.009,0,0,0-8,8V77a8.009,8.009,0,0,0,8,8ZM20,19a6.007,6.007,0,0,1,6-6H59.059A5.96,5.96,0,0,1,63.3,14.757L74.242,25.7A5.96,5.96,0,0,1,76,29.941V77a6.007,6.007,0,0,1-6,6H26a6.007,6.007,0,0,1-6-6Zm6.614,51.06h0L68,69.98a.75.75,0,0,0,.545-1.263L57.67,57.129a1.99,1.99,0,0,0-2.808-.028L51.6,60.467l-.024.026-7.087-7.543a1.73,1.73,0,0,0-1.229-.535,1.765,1.765,0,0,0-1.249.5L26.084,68.778a.75.75,0,0,0,.529,1.281Zm26.061-8.548,3.252-3.354a.333.333,0,0,1,.332-.123.463.463,0,0,1,.324.126L66.27,68.484l-7.177.014-6.5-6.916a.735.735,0,0,0,.078-.071Zm-9.611-7.526a.235.235,0,0,1,.168-.069.212.212,0,0,1,.168.068L57.039,68.5l-28.606.055Zm20.05-.43h.079a5.087,5.087,0,0,0,3.583-1.47,5.146,5.146,0,1,0-7.279-.109,5.089,5.089,0,0,0,3.617,1.579Zm-2.456-7.839a3.6,3.6,0,0,1,2.534-1.042h.056a3.7,3.7,0,0,1,2.478,6.34,3.51,3.51,0,0,1-2.589,1.041,3.6,3.6,0,0,1-2.557-1.118,3.715,3.715,0,0,1,.079-5.221Z",transform:"translate(-18 -11)",fill:"#8e8e8e"})})}const oe=({className:e,...t})=>{const{products:n}=k();return n.length?d("button",{...t,type:"submit",className:q(["search-popover-view-all",e]),children:"View All"}):d(B,{})};function ae(){const{products:e,route:t}=k(),{publishSearchProductClick:n}=re(),c=(r,o)=>{r.preventDefault();const a=r.currentTarget;n(o.sku),I(R.SEARCH_PRODUCT_CLICK),window.location.href=a.href};return A("div",{className:q("search-popover-root","grid grid-cols-1 gap-4"),children:[e.map(r=>A("div",{className:"relative flex items-center px-6 py-5 space-x-3 bg-white border border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2 hover:border-gray-400",children:[d("div",{className:"flex-shrink-0",children:d(se,{product:r})}),d("div",{className:"flex-1 min-w-0",children:A("a",{href:t==null?void 0:t({sku:r.sku,urlKey:r.urlKey??""}),onClick:o=>c(o,r),className:"focus:outline-none",children:[d("span",{"aria-hidden":"true",className:"inset-0"}),d("p",{className:"font-medium text-gray-900",children:r.name}),d("p",{className:"mt-4 text-gray-500 no-underline",children:r.price})]})})]},r.uid)),d(oe,{})]})}function se({product:e}){return e.image?d("img",{alt:"",src:e.image,className:"h-56"}):d(ce,{})}var ie="Expected a function",j=NaN,ue="[object Symbol]",de=/^\s+|\s+$/g,fe=/^[-+]0x[0-9a-f]+$/i,le=/^0b[01]+$/i,pe=/^0o[0-7]+$/i,he=parseInt,me=typeof x=="object"&&x&&x.Object===Object&&x,ge=typeof self=="object"&&self&&self.Object===Object&&self,Se=me||ge||Function("return this")(),Ce=Object.prototype,Ee=Ce.toString,be=Math.max,ve=Math.min,P=function(){return Se.Date.now()};function ye(e,t,n){var c,r,o,a,i,s,f=0,l=!1,g=!1,S=!0;if(typeof e!="function")throw new TypeError(ie);t=V(t)||0,O(n)&&(l=!!n.leading,g="maxWait"in n,o=g?be(V(n.maxWait)||0,t):o,S="trailing"in n?!!n.trailing:S);function b(u){var m=c,v=r;return c=r=void 0,f=u,a=e.apply(v,m),a}function p(u){return f=u,i=setTimeout(_,t),l?b(u):a}function h(u){var m=u-s,v=u-f,H=t-m;return g?ve(H,o-v):H}function T(u){var m=u-s,v=u-f;return s===void 0||m>=t||m<0||g&&v>=o}function _(){var u=P();if(T(u))return U(u);i=setTimeout(_,h(u))}function U(u){return i=void 0,S&&c?b(u):(c=r=void 0,a)}function X(){i!==void 0&&clearTimeout(i),f=0,c=s=r=i=void 0}function z(){return i===void 0?a:U(P())}function N(){var u=P(),m=T(u);if(c=arguments,r=this,s=u,m){if(i===void 0)return p(s);if(g)return i=setTimeout(_,t),b(s)}return i===void 0&&(i=setTimeout(_,t)),a}return N.cancel=X,N.flush=z,N}function O(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function Re(e){return!!e&&typeof e=="object"}function Ie(e){return typeof e=="symbol"||Re(e)&&Ee.call(e)==ue}function V(e){if(typeof e=="number")return e;if(Ie(e))return j;if(O(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=O(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=e.replace(de,"");var n=le.test(e);return n||pe.test(e)?he(e.slice(2),n?2:8):fe.test(e)?j:+e}var Te=ye;const M=J(Te);function _e(e){const t=E(e);t.current=e,y(()=>()=>{t.current()},[])}function xe(e,t=500,n){const c=E();_e(()=>{c.current&&c.current.cancel()});const r=Q(()=>{const o=M(e,t,n),a=(...i)=>o(...i);return a.cancel=()=>{o.cancel()},a.isPending=()=>!!c.current,a.flush=()=>o.flush(),a},[e,t,n]);return y(()=>{c.current=M(e,t,n)},[e,t,n]),r}function Le(e,t,n){const c=(f,l)=>f===l,r=e instanceof Function?e():e,[o,a]=F(r),i=E(r),s=xe(a,t,n);return c(i.current,r)||(s(r),i.current=r),[o,s]}const we=(e,t,n,c,r)=>{var f;const a=w().getState(L.SEARCH_INPUT_CONTEXT)??{units:[]},i={searchUnitId:e,searchRequestId:t,queryTypes:["products","suggestions"],phrase:n,pageSize:r,currentPage:1,filter:c,sort:[]},s=(f=a.units)==null?void 0:f.findIndex(l=>(l==null?void 0:l.searchUnitId)===e);s===void 0||s<0?a.units.push(i):a.units[s]=i,K(L.SEARCH_INPUT_CONTEXT,a)},Ne=(e,t,n)=>{var i;const r=w().getState(L.SEARCH_RESULTS_CONTEXT)??{units:[]},o=(i=r==null?void 0:r.units)==null?void 0:i.findIndex(s=>(s==null?void 0:s.searchUnitId)===e),a={searchUnitId:e,searchRequestId:t,products:(n==null?void 0:n.products.map(s=>({...s,price:Number(s.price)})))??[],categories:[],suggestions:[],page:(n==null?void 0:n.pageInfo.current)||1,perPage:(n==null?void 0:n.pageInfo.size)||6,facets:[]};o===void 0||o<0?r.units.push(a):r.units[o]=a,K(L.SEARCH_RESULTS_CONTEXT,r)},Ae={filters:[{attribute:"visibility",in:["Search","Catalog, Search"]},{attribute:"inStock",eq:"false"}],sort:[]};function Pe(e,t){switch(t.type){case"SET_IN_STOCK_FILTER":return{...e,filters:e.filters.map(n=>(n.attribute==="inStock"&&(n.eq=`${t.value.toString()}`),n))};default:throw Error(`Unknown action: ${t.type}`)}}const Oe=e=>{const[t,n]=W(Pe,Ae);return{search:async r=>{const o=ne();we(C,o,r,t.filters,e.pageSize),I(R.SEARCH_REQUEST_SENT,{searchUnitId:C});const a=await Y(r,e.pageSize);return Ne(C,o,a),I(R.SEARCH_RESPONSE_RECEIVED,{searchUnitId:C}),I(R.SEARCH_RESULTS_VIEW,{searchUnitId:C}),a}}},ke={products:[],config:{pageSize:8,perPageConfig:{pageSizeOptions:"12,24,36",defaultPageSizeOption:"24"},minQueryLength:"2",currencySymbol:"$",currencyRate:"1",displayOutOfStock:!0,allowAllProducts:!1},route:({sku:e,urlKey:t})=>`/products/${t}/${e}`},D=Z(ke),De=({children:e,storefrontDetails:t})=>{const{config:n,route:c}=t,{search:r}=Oe(n);y(()=>{ee(t.apiUrl),te({"Magento-Environment-Id":t.environmentId,"Magento-Website-Code":t.websiteCode,"Magento-Store-Code":t.storeCode,"Magento-Store-View-Code":t.storeViewCode,"X-Api-Key":t.apiKey})},[t.apiKey,t.apiUrl,t.environmentId,t.storeCode,t.storeViewCode,t.websiteCode]);const o=E(null),a=E(null),i=E(null),[s,f]=Le("",500),[l,g]=F([]),S=p=>{f(p.currentTarget.value)};y(()=>{const p=document.getElementById("search_mini_form"),h=document.getElementById("search"),T=document.getElementById("search_autocomplete");return o.current=p,a.current=h,i.current=T,h==null||h.addEventListener("input",S),()=>{h==null||h.removeEventListener("input",S)}},[]),y(()=>{(async()=>{if(s.length>+n.minQueryLength){const p=await r(s);g((p==null?void 0:p.products)??[])}})()},[s,n.minQueryLength,n.pageSize]);const b={products:l,config:n,route:c};return d(D.Provider,{value:b,children:d(ae,{})})},k=()=>{const e=G(D);if(e===null){const t=new Error("Missing <PopoverProvider /> component.");throw Error.captureStackTrace&&Error.captureStackTrace(t,k),t}return e};export{D as PopoverContext,De as SearchPopover,De as default,k as usePopover};
